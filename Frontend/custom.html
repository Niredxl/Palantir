<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palantir - Asteroid Impact Simulator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div id="map"></div>

    <div class="instruction" id="instruction">
        <h2>üåç Drop an Asteroid</h2>
        <p>Click anywhere on the map to see the devastating impact of your asteroid</p>
    </div>

    <div class="control-panel">
        <h1>‚ö° Palantir</h1>
        <p class="subtitle">Asteroid Impact Simulator</p>

        <div class="control-group">
            <label>
                Asteroid Diameter
                <span class="value-display" id="diameter-display">100 m</span>
            </label>
            <input type="range" id="diameter" min="10" max="10000" value="100" step="10">
        </div>

        <div class="control-group">
            <label>
                Impact Velocity
                <span class="value-display" id="velocity-display">20 km/s</span>
            </label>
            <input type="range" id="velocity" min="11" max="72" value="20" step="1">
        </div>

        <div class="control-group">
            <label>
                Impact Angle
                <span class="value-display" id="angle-display">45¬∞</span>
            </label>
            <input type="range" id="angle" min="15" max="90" value="45" step="5">
        </div>

        <div class="control-group">
            <label>Asteroid Composition</label>
            <select id="composition">
                <option value="7800">Iron (7,800 kg/m¬≥)</option>
                <option value="3000">Stone (3,000 kg/m¬≥)</option>
                <option value="1000">Ice (1,000 kg/m¬≥)</option>
                <option value="2000">Carbon-rich (2,000 kg/m¬≥)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Impact Location</label>
            <select id="target-type">
                <option value="land">Land</option>
                <option value="water">Water (Ocean)</option>
            </select>
        </div>

        <button id="random-btn">üé≤ Random Asteroid</button>
        <button id="mitigationMainBtn" class="preset-button" style="background: linear-gradient(135deg, #00ff88, #00ccff); color: #000; font-weight: bold;">
            üõ°Ô∏è Mitigation Strategies
        </button>

        <div class="control-group" style="margin-top: 20px;">
            <label>Famous Asteroids</label>
            <button class="preset-button" data-preset="tunguska">Tunguska Event (1908)</button>
            <button class="preset-button" data-preset="chelyabinsk">Chelyabinsk (2013)</button>
            <button class="preset-button" data-preset="barringer">Barringer Crater</button>
            <button class="preset-button" data-preset="chicxulub">Chicxulub (Dinosaurs)</button>
        </div>
    </div>

    <div class="info-panel">
        <h2>üìä Impact Results</h2>
        <div id="results">
            <div class="stat">
                <div class="stat-label">Impact Energy</div>
                <div class="stat-value">
                    <span id="energy">-</span>
                    <span class="stat-unit">Megatons</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Crater Diameter</div>
                <div class="stat-value">
                    <span id="crater">-</span>
                    <span class="stat-unit">meters</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Fireball Radius</div>
                <div class="stat-value">
                    <span id="fireball">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Air Blast Radius</div>
                <div class="stat-value">
                    <span id="blast">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Thermal Radiation</div>
                <div class="stat-value">
                    <span id="thermal">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Seismic Effect</div>
                <div class="stat-value">
                    <span id="seismic">-</span>
                    <span class="stat-unit">Richter</span>
                </div>
            </div>

            <div class="energy-display">
                <strong>Energy Comparison:</strong><br>
                <span id="comparison">-</span>
            </div>

            <div class="stat" style="border-left-color: var(--warning);">
                <div class="stat-label">Location Type</div>
                <div class="stat-value" style="color: var(--warning); font-size: 14px;">
                    <span id="locationType">-</span>
                </div>
            </div>

            <div class="stat" style="border-left-color: var(--danger);">
                <div class="stat-label">Total Estimated Casualties</div>
                <div class="stat-value" style="color: var(--danger);">
                    <span id="casualties">-</span>
                </div>
            </div>

            <div id="casualtyBreakdown" style="display: none; margin-top: 10px; font-size: 12px; padding: 12px; background: rgba(255, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(255, 68, 68, 0.2);">
                <div style="font-weight: bold; margin-bottom: 8px; color: var(--danger);">üìä Casualty Breakdown:</div>
                <div style="margin-bottom: 5px;">
                    <span style="color: var(--text-dim);">Population Density:</span> 
                    <span id="popDensity" style="color: var(--text-light);">-</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <span style="color: var(--text-dim);">Blast Zone (95% fatal):</span> 
                    <span id="blastCasualties" style="color: var(--text-light);">-</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <span style="color: var(--text-dim);">Thermal Zone (50% fatal):</span> 
                    <span id="thermalCasualties" style="color: var(--text-light);">-</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <span style="color: var(--text-dim);">Building Collapse:</span> 
                    <span id="buildingCasualties" style="color: var(--text-light);">-</span>
                </div>
                <div id="tsunamiRow" style="margin-bottom: 5px; display: none;">
                    <span style="color: var(--text-dim);">Tsunami (coastal):</span> 
                    <span id="tsunamiCasualties" style="color: var(--text-light);">-</span>
                </div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <span style="color: var(--text-dim);">Calculation:</span><br>
                    <span id="calculation" style="color: var(--text-dim); font-size: 11px; line-height: 1.4;">-</span>
                </div>
            </div>

            <button id="trajectoryBtn" class="preset-button" style="margin-top: 15px; display: none;">
                üöÄ View Trajectory Animation
            </button>

            <button id="mitigationBtn" class="preset-button" style="margin-top: 5px; display: none;">
                üõ°Ô∏è Evaluate Mitigation Strategies
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [40.7128, -74.0060], // New York
            zoom: 11,
            zoomControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // State
        let currentImpactMarkers = [];

        // Get elements
        const diameterSlider = document.getElementById('diameter');
        const velocitySlider = document.getElementById('velocity');
        const angleSlider = document.getElementById('angle');
        const compositionSelect = document.getElementById('composition');
        const targetTypeSelect = document.getElementById('target-type');
        const instruction = document.getElementById('instruction');

        // Update displays
        diameterSlider.addEventListener('input', (e) => {
            document.getElementById('diameter-display').textContent = e.target.value + ' m';
        });

        velocitySlider.addEventListener('input', (e) => {
            document.getElementById('velocity-display').textContent = e.target.value + ' km/s';
        });

        angleSlider.addEventListener('input', (e) => {
            document.getElementById('angle-display').textContent = e.target.value + '¬∞';
        });

        // Physics calculations
        function calculateImpact(diameter, velocity, angle, density, targetType) {
            const radius = diameter / 2;
            const volume = (4/3) * Math.PI * Math.pow(radius, 3);
            const mass = volume * density;
            
            const velocityMs = velocity * 1000;
            const energy = 0.5 * mass * Math.pow(velocityMs, 2);
            const energyMegatons = energy / (4.184e15);
            
            const angleRad = angle * Math.PI / 180;
            const targetFactor = targetType === 'water' ? 1.3 : 1.0;
            const craterDiameter = Math.pow(energy / 1e15, 0.3) * Math.sin(angleRad) * targetFactor * 1000;
            
            const fireballRadius = 0.028 * Math.pow(energyMegatons, 0.33);
            const blastRadius = 0.22 * Math.pow(energyMegatons, 0.33);
            const thermalRadius = 0.67 * Math.pow(energyMegatons, 0.41);
            const seismic = 0.67 * Math.log10(energyMegatons) + 3.87;
            
            return {
                energy: energyMegatons,
                craterDiameter: craterDiameter,
                fireballRadius: fireballRadius,
                blastRadius: blastRadius,
                thermalRadius: thermalRadius,
                seismic: seismic,
                mass: mass
            };
        }

        function getEnergyComparison(megatons) {
            if (megatons < 0.001) {
                const tons = megatons * 1e6;
                return `${tons.toFixed(0)} tons of TNT`;
            } else if (megatons < 0.015) {
                const kilotons = megatons * 1000;
                return `${kilotons.toFixed(1)} kilotons (Small nuclear weapon)`;
            } else if (megatons < 1) {
                const kilotons = megatons * 1000;
                return `${kilotons.toFixed(0)} kilotons (Hiroshima was 15 kt)`;
            } else if (megatons < 50) {
                return `${megatons.toFixed(1)} megatons (Large nuclear weapon)`;
            } else if (megatons < 10000) {
                const factor = (megatons / 50).toFixed(0);
                return `${megatons.toFixed(0)} megatons (${factor}x largest nuclear test)`;
            } else {
                const factor = (megatons / 100000000).toFixed(2);
                return `${megatons.toFixed(0)} megatons (${factor}x Chicxulub impact)`;
            }
        }

        // Location-based factors database (simplified)
        const locationFactors = {
            urban: {
                populationDensity: 8000,
                buildingDensity: 0.7,
                description: 'Dense Urban Area'
            },
            suburban: {
                populationDensity: 3000,
                buildingDensity: 0.4,
                description: 'Suburban Area'
            },
            rural: {
                populationDensity: 100,
                buildingDensity: 0.05,
                description: 'Rural Area'
            },
            coastal: {
                populationDensity: 5000,
                buildingDensity: 0.5,
                description: 'Coastal Region (Tsunami Risk)'
            },
            mountain: {
                populationDensity: 50,
                buildingDensity: 0.02,
                description: 'Mountainous Terrain'
            },
            ocean: {
                populationDensity: 0,
                buildingDensity: 0,
                description: 'Open Ocean'
            }
        };

        // Comprehensive major cities database with population density
        const worldCities = [
            // Americas
            { name: 'New York', lat: 40.7128, lng: -74.0060, pop: 10000, type: 'urban', radius: 0.3 },
            { name: 'Los Angeles', lat: 34.0522, lng: -118.2437, pop: 8000, type: 'urban', radius: 0.4 },
            { name: 'Mexico City', lat: 19.4326, lng: -99.1332, pop: 12000, type: 'urban', radius: 0.35 },
            { name: 'S√£o Paulo', lat: -23.5505, lng: -46.6333, pop: 11000, type: 'urban', radius: 0.35 },
            { name: 'Chicago', lat: 41.8781, lng: -87.6298, pop: 4500, type: 'urban', radius: 0.25 },
            { name: 'Toronto', lat: 43.6532, lng: -79.3832, pop: 4200, type: 'urban', radius: 0.25 },
            
            // Europe
            { name: 'London', lat: 51.5074, lng: -0.1278, pop: 5700, type: 'urban', radius: 0.3 },
            { name: 'Paris', lat: 48.8566, lng: 2.3522, pop: 5500, type: 'urban', radius: 0.25 },
            { name: 'Moscow', lat: 55.7558, lng: 37.6173, pop: 5000, type: 'urban', radius: 0.3 },
            { name: 'Istanbul', lat: 41.0082, lng: 28.9784, pop: 7000, type: 'urban', radius: 0.35 },
            { name: 'Berlin', lat: 52.5200, lng: 13.4050, pop: 4000, type: 'urban', radius: 0.2 },
            { name: 'Madrid', lat: 40.4168, lng: -3.7038, pop: 3800, type: 'urban', radius: 0.2 },
            
            // Asia
            { name: 'Tokyo', lat: 35.6762, lng: 139.6503, pop: 15000, type: 'urban', radius: 0.4 },
            { name: 'Delhi', lat: 28.6139, lng: 77.2090, pop: 13000, type: 'urban', radius: 0.35 },
            { name: 'Shanghai', lat: 31.2304, lng: 121.4737, pop: 12000, type: 'urban', radius: 0.35 },
            { name: 'Mumbai', lat: 19.0760, lng: 72.8777, pop: 12500, type: 'urban', radius: 0.3 },
            { name: 'Beijing', lat: 39.9042, lng: 116.4074, pop: 11000, type: 'urban', radius: 0.35 },
            { name: 'Seoul', lat: 37.5665, lng: 126.9780, pop: 10000, type: 'urban', radius: 0.3 },
            { name: 'Jakarta', lat: -6.2088, lng: 106.8456, pop: 11500, type: 'urban', radius: 0.35 },
            { name: 'Bangkok', lat: 13.7563, lng: 100.5018, pop: 6000, type: 'urban', radius: 0.25 },
            { name: 'Singapore', lat: 1.3521, lng: 103.8198, pop: 8000, type: 'urban', radius: 0.15 },
            
            // Middle East
            { name: 'Dubai', lat: 25.2048, lng: 55.2708, pop: 6500, type: 'urban', radius: 0.2 },
            { name: 'Cairo', lat: 30.0444, lng: 31.2357, pop: 10000, type: 'urban', radius: 0.3 },
            
            // Africa
            { name: 'Lagos', lat: 6.5244, lng: 3.3792, pop: 8000, type: 'urban', radius: 0.25 },
            { name: 'Johannesburg', lat: -26.2041, lng: 28.0473, pop: 4500, type: 'urban', radius: 0.25 },
            
            // Oceania
            { name: 'Sydney', lat: -33.8688, lng: 151.2093, pop: 4000, type: 'urban', radius: 0.25 },
            { name: 'Melbourne', lat: -37.8136, lng: 144.9631, pop: 3500, type: 'urban', radius: 0.2 }
        ];

        // Determine location type with better accuracy
        function determineLocationType(lat, lng) {
            // First, check distance to major cities (prioritize this)
            for (let city of worldCities) {
                const distance = Math.sqrt(
                    Math.pow((lat - city.lat) * 111, 2) + 
                    Math.pow((lng - city.lng) * 111 * Math.cos(lat * Math.PI / 180), 2)
                );
                
                // Direct city hit
                if (distance < city.radius * 111) {
                    return { type: 'urban', city: city.name, density: city.pop };
                }
                // Suburban area around city
                if (distance < city.radius * 111 * 3) {
                    return { type: 'suburban', city: city.name, density: city.pop * 0.4 };
                }
            }

            // Check if truly in middle of ocean (very conservative check)
            // Only mark as ocean if far from all land
            const isDeepOcean = (
                // Pacific Ocean center
                (lng > 160 || lng < -140) && Math.abs(lat) < 50 && 
                !worldCities.some(c => {
                    const d = Math.sqrt(Math.pow((lat - c.lat) * 111, 2) + Math.pow((lng - c.lng) * 111, 2));
                    return d < 500; // Within 500km of any city
                })
            ) || (
                // Atlantic Ocean center
                lng > -60 && lng < -20 && lat > -30 && lat < 30 &&
                !worldCities.some(c => {
                    const d = Math.sqrt(Math.pow((lat - c.lat) * 111, 2) + Math.pow((lng - c.lng) * 111, 2));
                    return d < 500;
                })
            );
            
            if (isDeepOcean) {
                return { type: 'ocean', density: 0 };
            }

            // Check for coastal areas (near cities but not urban/suburban)
            const nearCoast = worldCities.some(city => {
                const distance = Math.sqrt(
                    Math.pow((lat - city.lat) * 111, 2) + 
                    Math.pow((lng - city.lng) * 111 * Math.cos(lat * Math.PI / 180), 2)
                );
                return distance < 200; // Within 200km
            });

            if (nearCoast) return { type: 'coastal', density: 2000 };

            // Mountainous regions
            if (Math.abs(lat) > 65 || 
                (lat > 25 && lat < 45 && lng > 65 && lng < 95) || // Himalayas
                (lat > 35 && lat < 50 && lng > -120 && lng < -105)) { // Rockies
                return { type: 'mountain', density: 50 };
            }

            // Default to rural (most land areas)
            return { type: 'rural', density: 500 };
        }

        async function estimateCasualties(blastRadius, thermalRadius, lat, lng) {
            // Determine location type with improved detection
            const locationResult = determineLocationType(lat, lng);
            
            let locationType, populationDensity, description, cityName;
            
            if (typeof locationResult === 'object' && locationResult.type) {
                locationType = locationResult.type;
                populationDensity = locationResult.density || locationFactors[locationType].populationDensity;
                cityName = locationResult.city;
                description = cityName ? 
                    `${locationFactors[locationType].description} (${cityName})` : 
                    locationFactors[locationType].description;
            } else {
                locationType = locationResult;
                const factors = locationFactors[locationType];
                populationDensity = factors.populationDensity;
                description = factors.description;
            }

            // Update location type display
            document.getElementById('locationType').textContent = description;

            // Show breakdown panel
            document.getElementById('casualtyBreakdown').style.display = 'block';
            document.getElementById('popDensity').textContent = `${populationDensity.toLocaleString()} people/km¬≤`;

            // If ocean, return minimal casualties
            if (locationType === 'ocean') {
                document.getElementById('casualtyBreakdown').style.display = 'none';
                return '0 people (Open Ocean)';
            }

            // Calculate affected areas (km¬≤)
            const blastArea = Math.PI * Math.pow(blastRadius, 2);
            const thermalArea = Math.PI * Math.pow(thermalRadius, 2);
            const thermalOnlyArea = Math.max(0, thermalArea - blastArea);

            // Get building density
            const buildingDensity = locationFactors[locationType]?.buildingDensity || 0.3;

            // DETAILED CASUALTY CALCULATIONS
            
            // 1. Immediate blast casualties (95% fatality in blast zone)
            const blastPopulation = blastArea * populationDensity;
            const blastDeaths = Math.floor(blastPopulation * 0.95);
            
            // 2. Thermal casualties (50% fatality in thermal-only zone)
            const thermalPopulation = thermalOnlyArea * populationDensity;
            const thermalDeaths = Math.floor(thermalPopulation * 0.5);
            
            // 3. Building collapse casualties (additional 20% in blast zone with buildings)
            const buildingCollapseDeaths = Math.floor(blastPopulation * buildingDensity * 0.2);
            
            // 4. Tsunami casualties for coastal regions
            let tsunamiDeaths = 0;
            const tsunamiRow = document.getElementById('tsunamiRow');
            if (locationType === 'coastal' && blastRadius > 1) {
                tsunamiDeaths = Math.floor(populationDensity * blastRadius * blastRadius * 8);
                tsunamiRow.style.display = 'block';
                document.getElementById('tsunamiCasualties').textContent = tsunamiDeaths.toLocaleString();
            } else {
                tsunamiRow.style.display = 'none';
            }

            // Update breakdown display
            document.getElementById('blastCasualties').textContent = blastDeaths.toLocaleString();
            document.getElementById('thermalCasualties').textContent = thermalDeaths.toLocaleString();
            document.getElementById('buildingCasualties').textContent = buildingCollapseDeaths.toLocaleString();

            // Total casualties
            const totalCasualties = blastDeaths + thermalDeaths + buildingCollapseDeaths + tsunamiDeaths;

            // Show calculation formula
            let calcText = `(${blastArea.toFixed(1)} km¬≤ √ó ${populationDensity} √ó 0.95) + `;
            calcText += `(${thermalOnlyArea.toFixed(1)} km¬≤ √ó ${populationDensity} √ó 0.5) + `;
            calcText += `(building collapse) `;
            if (tsunamiDeaths > 0) calcText += `+ (tsunami)`;
            document.getElementById('calculation').textContent = calcText;

            // Format output
            if (totalCasualties < 100) return `${totalCasualties} people`;
            if (totalCasualties < 1000) return `~${Math.ceil(totalCasualties / 100) * 100} people`;
            if (totalCasualties < 1000000) return `~${(totalCasualties / 1000).toFixed(1)}K people`;
            return `~${(totalCasualties / 1000000).toFixed(2)}M people`;
        }

        // Clear previous impact markers
        function clearImpact() {
            currentImpactMarkers.forEach(marker => map.removeLayer(marker));
            currentImpactMarkers = [];
        }

        // Store current impact data for trajectory page
        let currentImpactData = null;

        // Add impact flash effect to map
        function flashMap() {
            const flashDiv = document.createElement('div');
            flashDiv.style.position = 'fixed';
            flashDiv.style.top = '0';
            flashDiv.style.left = '0';
            flashDiv.style.width = '100%';
            flashDiv.style.height = '100vh';
            flashDiv.style.background = 'radial-gradient(circle, rgba(255,150,0,0.8) 0%, rgba(255,0,0,0.4) 100%)';
            flashDiv.style.zIndex = '900';
            flashDiv.style.pointerEvents = 'none';
            flashDiv.style.animation = 'impactFlash 0.8s ease-out';
            document.body.appendChild(flashDiv);
            
            setTimeout(() => document.body.removeChild(flashDiv), 800);
        }

        // Add shake effect to map
        function shakeMap() {
            const mapElement = document.getElementById('map');
            mapElement.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                mapElement.style.animation = '';
            }, 500);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes impactFlash {
                0% { opacity: 1; }
                100% { opacity: 0; }
            }
            @keyframes shake {
                0%, 100% { transform: translate(0, 0); }
                10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); }
                20%, 40%, 60%, 80% { transform: translate(5px, -5px); }
            }
        `;
        document.head.appendChild(style);

        // Handle map click
        map.on('click', async function(e) {
            instruction.classList.add('hidden');
            clearImpact();
            
            // Trigger impact effects
            flashMap();
            setTimeout(() => shakeMap(), 100);
            
            const diameter = parseFloat(diameterSlider.value);
            const velocity = parseFloat(velocitySlider.value);
            const angle = parseFloat(angleSlider.value);
            const density = parseFloat(compositionSelect.value);
            const targetType = targetTypeSelect.value;
            
            const impact = calculateImpact(diameter, velocity, angle, density, targetType);
            
            // Store impact data
            currentImpactData = {
                diameter: diameter,
                velocity: velocity,
                angle: angle,
                density: density,
                energy: impact.energy,
                lat: e.latlng.lat,
                lng: e.latlng.lng
            };
            
            // Update UI
            document.getElementById('energy').textContent = impact.energy.toExponential(2);
            document.getElementById('crater').textContent = impact.craterDiameter.toFixed(0);
            document.getElementById('fireball').textContent = impact.fireballRadius.toFixed(2);
            document.getElementById('blast').textContent = impact.blastRadius.toFixed(2);
            document.getElementById('thermal').textContent = impact.thermalRadius.toFixed(2);
            document.getElementById('seismic').textContent = impact.seismic.toFixed(1);
            document.getElementById('comparison').textContent = getEnergyComparison(impact.energy);
            
            // Calculate casualties with location-based factors
            const casualties = await estimateCasualties(
                impact.blastRadius, 
                impact.thermalRadius,
                e.latlng.lat,
                e.latlng.lng
            );
            document.getElementById('casualties').textContent = casualties;

            // Show trajectory button
            document.getElementById('trajectoryBtn').style.display = 'block';
            
            // Draw impact zones
            const zones = [
                { radius: impact.fireballRadius, color: '#ff0000', label: 'Fireball', opacity: 0.3 },
                { radius: impact.blastRadius, color: '#ff6600', label: 'Air Blast', opacity: 0.2 },
                { radius: impact.thermalRadius, color: '#ffaa00', label: 'Thermal Radiation', opacity: 0.15 }
            ];
            
            zones.forEach(zone => {
                const circle = L.circle(e.latlng, {
                    radius: zone.radius * 1000,
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: zone.opacity,
                    weight: 2
                }).addTo(map);
                
                circle.bindPopup(`<b>${zone.label}</b><br>Radius: ${zone.radius.toFixed(2)} km`);
                currentImpactMarkers.push(circle);
            });
            
            // Impact marker
            const marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'impact-marker',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            
            currentImpactMarkers.push(marker);
            
            // Zoom to fit
            const bounds = L.latLngBounds([e.latlng]);
            zones.forEach(zone => {
                const circleRadius = zone.radius * 1000;
                const point = L.latLng(e.latlng.lat, e.latlng.lng);
                bounds.extend(L.latLng(point.lat + circleRadius/111000, point.lng));
                bounds.extend(L.latLng(point.lat - circleRadius/111000, point.lng));
            });
            
            map.fitBounds(bounds, { padding: [50, 50] });
        });

        // Random asteroid
        document.getElementById('random-btn').addEventListener('click', () => {
            const randomDiameter = Math.floor(Math.random() * 2000) + 50;
            const randomVelocity = Math.floor(Math.random() * 50) + 15;
            const randomAngle = Math.floor(Math.random() * 75) + 15;
            
            diameterSlider.value = randomDiameter;
            velocitySlider.value = randomVelocity;
            angleSlider.value = randomAngle;
            
            document.getElementById('diameter-display').textContent = randomDiameter + ' m';
            document.getElementById('velocity-display').textContent = randomVelocity + ' km/s';
            document.getElementById('angle-display').textContent = randomAngle + '¬∞';
        });

        // Presets
        const presets = {
            tunguska: { diameter: 60, velocity: 27, angle: 45, density: 1000 },
            chelyabinsk: { diameter: 20, velocity: 19, angle: 18, density: 3500 },
            barringer: { diameter: 50, velocity: 12.8, angle: 45, density: 7800 },
            chicxulub: { diameter: 10000, velocity: 20, angle: 60, density: 3000 }
        };

        document.querySelectorAll('.preset-button').forEach(button => {
            button.addEventListener('click', () => {
                const preset = presets[button.dataset.preset];
                diameterSlider.value = preset.diameter;
                velocitySlider.value = preset.velocity;
                angleSlider.value = preset.angle;
                compositionSelect.value = preset.density;
                
                document.getElementById('diameter-display').textContent = preset.diameter + ' m';
                document.getElementById('velocity-display').textContent = preset.velocity + ' km/s';
                document.getElementById('angle-display').textContent = preset.angle + '¬∞';
            });
        });

        // Trajectory button handler (after impact)
        document.getElementById('trajectoryBtn').addEventListener('click', () => {
            if (currentImpactData) {
                const params = new URLSearchParams({
                    diameter: currentImpactData.diameter,
                    velocity: currentImpactData.velocity,
                    angle: currentImpactData.angle,
                    density: currentImpactData.density,
                    energy: currentImpactData.energy,
                    lat: currentImpactData.lat,
                    lng: currentImpactData.lng
                });
                window.location.href = `trajectory.html?${params.toString()}`;
            }
        });

        // Mitigation button handler (after impact)
        document.getElementById('mitigationBtn').addEventListener('click', () => {
            if (currentImpactData) {
                const params = new URLSearchParams({
                    diameter: currentImpactData.diameter,
                    velocity: currentImpactData.velocity,
                    density: currentImpactData.density,
                    energy: currentImpactData.energy
                });
                window.location.href = `mitigation.html?${params.toString()}`;
            }
        });

        // Mitigation main button handler (always available)
        document.getElementById('mitigationMainBtn').addEventListener('click', () => {
            const params = new URLSearchParams({
                diameter: parseFloat(diameterSlider.value),
                velocity: parseFloat(velocitySlider.value),
                density: parseFloat(compositionSelect.value),
                energy: 0
            });
            window.location.href = `mitigation.html?${params.toString()}`;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                document.getElementById('random-btn').click();
            } else if (e.key === 'c' || e.key === 'C') {
                clearImpact();
            } else if (e.key === 't' || e.key === 'T') {
                if (currentImpactData) {
                    document.getElementById('trajectoryBtn').click();
                }
            } else if (e.key === 'm' || e.key === 'M') {
                if (currentImpactData) {
                    document.getElementById('mitigationBtn').click();
                } else {
                    document.getElementById('mitigationMainBtn').click();
                }
            }
        });
    </script>
</body>
</html>